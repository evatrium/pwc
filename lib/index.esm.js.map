{"version":3,"file":"index.esm.js","sources":["../src/utils.js","../src/PWC.js"],"sourcesContent":["import {isArray, isObj} from \"@iosio/util\";\n\nlet d = document,\n    TEST_ENV = process.env.NODE_ENV === 'test',\n    /**\n     * creates a single style sheet. returns a function to add to the same sheet\n     * @returns {function} for adding styles to the same stylesheet\n     */\n    styleSheet = (style) => {\n         style = d.createElement('style');\n         d.head.appendChild(style);\n        return (css) => (style.appendChild(d.createTextNode(css)), style);\n    },\n    globalStyles = styleSheet(),\n    visibilityStyleSheet = styleSheet(),\n    webComponentVisibility = (tag) => visibilityStyleSheet(`${tag} {visibility:hidden}`),\n    /**\n     * for parsing the incoming attributes into consumable props\n     * @param value\n     * @param type\n     * @returns {{error: boolean, value: *}}\n     */\n    formatType = (value, type) => {\n        type = type || String;\n        try {\n            if (type == Boolean) value = [true, 1, \"\", \"1\", \"true\"].includes(value);\n            else if (typeof value == \"string\") {\n                value = type == Number ? Number(value)\n                    : type == Object || type == Array ? JSON.parse(value) : value;\n            }\n            if ({}.toString.call(value) == `[object ${type.name}]`)\n                return {value, error: type == Number && Number.isNaN(value)};\n        } catch (e) {\n        }\n        return {value, error: true};\n    },\n\n    /**\n     * will set or remove the attribute based on the truthyness of the value.\n     * if the type of value === object (accounts for array) and the node is a custom pwc, it will json stringify the value\n     * @param node\n     * @param attr\n     * @param value\n     */\n    updateAttribute = (node, attr, value) => {\n        (value === null || value === false)\n            ? node.removeAttribute(attr)\n            : node.setAttribute(attr, (isObj(value) || isArray(value)) ? JSON.stringify(value) : value);\n    },\n    propToAttr = (prop) => prop.replace(/([A-Z])/g, \"-$1\").toLowerCase(),\n    attrToProp = (attr) => attr.replace(/-(\\w)/g, (all, letter) => letter.toUpperCase());\n\n\n    visibilityStyleSheet(` .___ {visibility: inherit;}`, true);\n\nexport {\n    TEST_ENV,\n    styleSheet,\n    globalStyles,\n    webComponentVisibility,\n    formatType,\n    updateAttribute,\n    propToAttr,\n    attrToProp,\n};\n","import {\n    formatType,\n    updateAttribute,\n    propToAttr,\n    attrToProp,\n    webComponentVisibility,\n    TEST_ENV\n} from \"../src/utils\";\n\nimport {def, extend} from \"@iosio/util\";\n\nimport {h, render} from \"preact\";\n\nlet PROPS = Symbol(),\n    IGNORE_ATTR = Symbol(),\n    context = {},\n    pwc = (tag, component, propTypes) => {\n        webComponentVisibility(tag);\n        customElements.define(tag, class extends PWC {\n                static propTypes = component.propTypes || propTypes;\n                render = props => h(component, props);\n            }\n        );\n        return (props) => h(tag, props, props.children);\n    },\n    x = (t, c, p) => pwc('x-' + t, c, p);\n\n\nclass PWC extends HTMLElement {\n    //easier theming\n    context = context;\n\n    constructor() {\n        super();\n        this._root = this.attachShadow({mode: 'open'});//  (this.shadowRoot || this) maybe eventually include the option to not use shadowDom\n        this[PROPS] = {};\n        this._mounted = new Promise(mount => (this._mount = mount));\n        this.update();\n        let {_initAttrs} = this.constructor;\n        let length = _initAttrs.length;\n        while (length--) _initAttrs[length](this);\n    }\n\n    /*\n     adding visibility inherit on next tick after (inspired by stencil.js)\n     will prevent flash of un-styled content (common complaint with web components).\n     Removing this functionality during testing makes life easier\n    */\n    update = () => {\n        if (!this._process) {\n            this._process = this._mounted.then(_ => {\n                render(this.render(extend({host: this}, this[PROPS])), this._root);\n                !this._hasMounted && !TEST_ENV && requestAnimationFrame(() => this.classList.add('___'));\n                this._hasMounted = true;\n                this._process = false;\n            });\n        }\n        return this._process;\n    };\n\n    connectedCallback() {\n        !this._hasMounted && this._mount();\n    }\n\n    emit = (name, detail, from) =>\n        (from || this).dispatchEvent(\n            new CustomEvent(name, {detail, bubbles: true, composed: true})\n        );\n\n    attributeChangedCallback(attr, oldValue, newValue) {\n        if (attr === this[IGNORE_ATTR] || oldValue === newValue) return;\n        this[attrToProp(attr)] = newValue;\n    }\n\n    /*\n        inspired by atomico\n        converts attributes to props as defined in the static propTypes.\n        defers the upgrading of the attributes till mounted, ignoring them to avoid re-rendering\n    */\n    static get observedAttributes() {\n        let {propTypes, prototype} = this;\n        this._initAttrs = [];\n        if (!propTypes) return [];\n        return Object.keys(propTypes).map(prop => {\n            let attr = propToAttr(prop),\n                schema = propTypes[prop].name ? {type: propTypes[prop]} : propTypes[prop];\n            if (!(prop in prototype)) {\n                def(prototype, prop, {\n                    get() {\n                        return this[PROPS][prop]\n                    },\n                    set(nextValue) {\n                        let {value, error} = formatType(nextValue, schema.type);\n                        if (error && value != null) throw `[${prop}] must be type [${schema.type.name}]`;\n                        if (value === this[PROPS][prop]) return;\n                        if (schema.reflect) {\n                            this._mounted.then(() => {\n                                this[IGNORE_ATTR] = attr;\n                                updateAttribute(this, attr, schema.type === Boolean && !value ? null : value);\n                                this[IGNORE_ATTR] = false;\n                            });\n                        }\n                        this[PROPS][prop] = value;\n                        this.update();\n                    }\n                });\n            }\n            schema.value && this._initAttrs.push(self => (self[prop] = schema.value));\n            return attr;\n        });\n    };\n\n    /*  web components may call disconnected callback when the node is just being moved.\n        for example, if a user manually relocates the web component in the dom via something like node.insertBefore ...\n        so checking if the web component is still connected is necessary  */\n    disconnectedCallback() {\n        !this.isConnected && render(() => null, this._root);\n    }\n}\n\nexport {x, pwc, context}\n\n\n\n"],"names":["d","document","TEST_ENV","undefined","styleSheet","style","createElement","head","appendChild","css","createTextNode","globalStyles","visibilityStyleSheet","formatType","value","type","String","Boolean","includes","Number","Object","Array","JSON","parse","toString","call","name","error","isNaN","e","updateAttribute","node","attr","removeAttribute","setAttribute","isObj","isArray","stringify","propToAttr","prop","replace","toLowerCase","attrToProp","all","letter","toUpperCase","PROPS","Symbol","IGNORE_ATTR","context","pwc","tag","component","propTypes","webComponentVisibility","customElements","define","PWC","render","props","h","children","x","t","c","p","HTMLElement","constructor","update","this","_process","_mounted","then","_","extend","host","_root","_hasMounted","requestAnimationFrame","classList","add","emit","detail","from","dispatchEvent","CustomEvent","bubbles","composed","attachShadow","mode","Promise","mount","_mount","l","_initAttrs","length","connectedCallback","attributeChangedCallback","oldValue","newValue","prototype","keys","map","schema","def","get","set","nextValue","reflect","push","self","disconnectedCallback","isConnected"],"mappings":"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"}