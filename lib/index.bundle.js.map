{"version":3,"file":"index.bundle.js","sources":["../src/utils.js","../src/PWC.js"],"sourcesContent":["import {isArray, isObj} from \"@iosio/util\";\n\nlet d = document,\n    TEST_ENV = process.env.NODE_ENV === 'test',\n    /**\n     * creates a single style sheet. returns a function to add to the same sheet\n     * @returns {function} for adding styles to the same stylesheet\n     */\n    styleSheet = (style) => {\n         style = d.createElement('style');\n         d.head.appendChild(style);\n        return (css) => (style.appendChild(d.createTextNode(css)), style);\n    },\n    globalStyles = styleSheet(),\n    visibilityStyleSheet = styleSheet(),\n    webComponentVisibility = (tag) => visibilityStyleSheet(`${tag} {visibility:hidden}`),\n    /**\n     * for parsing the incoming attributes into consumable props\n     * @param value\n     * @param type\n     * @returns {{error: boolean, value: *}}\n     */\n    formatType = (value, type) => {\n        type = type || String;\n        try {\n            if (type == Boolean) value = [true, 1, \"\", \"1\", \"true\"].includes(value);\n            else if (typeof value == \"string\") {\n                value = type == Number ? Number(value)\n                    : type == Object || type == Array ? JSON.parse(value) : value;\n            }\n            if ({}.toString.call(value) == `[object ${type.name}]`)\n                return {value, error: type == Number && Number.isNaN(value)};\n        } catch (e) {\n        }\n        return {value, error: true};\n    },\n\n    /**\n     * will set or remove the attribute based on the truthyness of the value.\n     * if the type of value === object (accounts for array) and the node is a custom pwc, it will json stringify the value\n     * @param node\n     * @param attr\n     * @param value\n     */\n    updateAttribute = (node, attr, value) => {\n        (value === null || value === false)\n            ? node.removeAttribute(attr)\n            : node.setAttribute(attr, (isObj(value) || isArray(value)) ? JSON.stringify(value) : value);\n    },\n    propToAttr = (prop) => prop.replace(/([A-Z])/g, \"-$1\").toLowerCase(),\n    attrToProp = (attr) => attr.replace(/-(\\w)/g, (all, letter) => letter.toUpperCase());\n\n\n    visibilityStyleSheet(` .___ {visibility: inherit;}`, true);\n\nexport {\n    TEST_ENV,\n    styleSheet,\n    globalStyles,\n    webComponentVisibility,\n    formatType,\n    updateAttribute,\n    propToAttr,\n    attrToProp,\n};\n","import {\n    formatType,\n    updateAttribute,\n    propToAttr,\n    attrToProp,\n    webComponentVisibility,\n    TEST_ENV\n} from \"../src/utils\";\n\nimport {def, extend} from \"@iosio/util\";\n\nimport {h, render} from \"preact\";\n\nlet PROPS = Symbol(),\n    IGNORE_ATTR = Symbol(),\n    context = {},\n    pwc = (tag, component, propTypes) => {\n        webComponentVisibility(tag);\n        customElements.define(tag, class extends PWC {\n                static propTypes = component.propTypes || propTypes;\n                render = props => h(component, props);\n            }\n        );\n        return (props) => h(tag, props, props.children);\n    },\n    x = (t, c, p) => pwc('x-' + t, c, p);\n\n\nclass PWC extends HTMLElement {\n    //easier theming\n    context = context;\n\n    constructor() {\n        super();\n        this._root = this.attachShadow({mode: 'open'});//  (this.shadowRoot || this) maybe eventually include the option to not use shadowDom\n        this[PROPS] = {};\n        this._mounted = new Promise(mount => (this._mount = mount));\n        this.update();\n        let {_initAttrs} = this.constructor;\n        let length = _initAttrs.length;\n        while (length--) _initAttrs[length](this);\n    }\n\n    /*\n     adding visibility inherit on next tick after (inspired by stencil.js)\n     will prevent flash of un-styled content (common complaint with web components).\n     Removing this functionality during testing makes life easier\n    */\n    update = () => {\n        if (!this._process) {\n            this._process = this._mounted.then(_ => {\n                render(this.render(extend({host: this}, this[PROPS])), this._root);\n                !this._hasMounted && !TEST_ENV && requestAnimationFrame(() => this.classList.add('___'));\n                this._hasMounted = true;\n                this._process = false;\n            });\n        }\n        return this._process;\n    };\n\n    connectedCallback() {\n        !this._hasMounted && this._mount();\n    }\n\n    emit = (name, detail, from) =>\n        (from || this).dispatchEvent(\n            new CustomEvent(name, {detail, bubbles: true, composed: true})\n        );\n\n    attributeChangedCallback(attr, oldValue, newValue) {\n        if (attr === this[IGNORE_ATTR] || oldValue === newValue) return;\n        this[attrToProp(attr)] = newValue;\n    }\n\n    /*\n        inspired by atomico\n        converts attributes to props as defined in the static propTypes.\n        defers the upgrading of the attributes till mounted, ignoring them to avoid re-rendering\n    */\n    static get observedAttributes() {\n        let {propTypes, prototype} = this;\n        this._initAttrs = [];\n        if (!propTypes) return [];\n        return Object.keys(propTypes).map(prop => {\n            let attr = propToAttr(prop),\n                schema = propTypes[prop].name ? {type: propTypes[prop]} : propTypes[prop];\n            if (!(prop in prototype)) {\n                def(prototype, prop, {\n                    get() {\n                        return this[PROPS][prop]\n                    },\n                    set(nextValue) {\n                        let {value, error} = formatType(nextValue, schema.type);\n                        if (error && value != null) throw `[${prop}] must be type [${schema.type.name}]`;\n                        if (value === this[PROPS][prop]) return;\n                        if (schema.reflect) {\n                            this._mounted.then(() => {\n                                this[IGNORE_ATTR] = attr;\n                                updateAttribute(this, attr, schema.type === Boolean && !value ? null : value);\n                                this[IGNORE_ATTR] = false;\n                            });\n                        }\n                        this[PROPS][prop] = value;\n                        this.update();\n                    }\n                });\n            }\n            schema.value && this._initAttrs.push(self => (self[prop] = schema.value));\n            return attr;\n        });\n    };\n\n    /*  web components may call disconnected callback when the node is just being moved.\n        for example, if a user manually relocates the web component in the dom via something like node.insertBefore ...\n        so checking if the web component is still connected is necessary  */\n    disconnectedCallback() {\n        !this.isConnected && render(() => null, this._root);\n    }\n}\n\nexport {x, pwc, context}\n\n\n\n"],"names":["d","document","TEST_ENV","undefined","styleSheet","style","createElement","head","appendChild","css","createTextNode","globalStyles","visibilityStyleSheet","PROPS","Symbol","IGNORE_ATTR","context","pwc","tag","component","propTypes","webComponentVisibility","customElements","define","render","props","h","PWC","children","update","_this2","_process","_mounted","then","_","extend","host","_root","_hasMounted","requestAnimationFrame","classList","add","emit","name","detail","from","dispatchEvent","CustomEvent","bubbles","composed","attachShadow","mode","Promise","mount","_mount","_initAttrs","constructor","length","HTMLElement","this","prototype","Object","keys","map","prop","attr","replace","toLowerCase","propToAttr","schema","type","def","get","set","nextValue","value","String","Boolean","includes","Number","Array","JSON","parse","toString","call","error","isNaN","e","formatType","reflect","_this4","node","removeAttribute","setAttribute","isObj","isArray","stringify","updateAttribute","_this3","push","self","oldValue","newValue","all","letter","toUpperCase","attrToProp","isConnected","t","c","p"],"mappings":"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"}