{"version":3,"file":"index.js","sources":["../src/utils.js","../src/PWC.js"],"sourcesContent":["import {isArray, isObj} from \"@iosio/util\";\n\nlet d = document,\n    TEST_ENV = process.env.NODE_ENV === 'test',\n    /**\n     * creates a single style sheet. returns a function to add to the same sheet\n     * @returns {function} for adding styles to the same stylesheet\n     */\n    styleSheet = (style) => {\n         style = d.createElement('style');\n         d.head.appendChild(style);\n        return (css) => (style.appendChild(d.createTextNode(css)), style);\n    },\n    globalStyles = styleSheet(),\n    visibilityStyleSheet = styleSheet(),\n    webComponentVisibility = (tag) => visibilityStyleSheet(`${tag} {visibility:hidden}`),\n    /**\n     * for parsing the incoming attributes into consumable props\n     * @param value\n     * @param type\n     * @returns {{error: boolean, value: *}}\n     */\n    formatType = (value, type) => {\n        type = type || String;\n        try {\n            if (type == Boolean) value = [true, 1, \"\", \"1\", \"true\"].includes(value);\n            else if (typeof value == \"string\") {\n                value = type == Number ? Number(value)\n                    : type == Object || type == Array ? JSON.parse(value) : value;\n            }\n            if ({}.toString.call(value) == `[object ${type.name}]`)\n                return {value, error: type == Number && Number.isNaN(value)};\n        } catch (e) {\n        }\n        return {value, error: true};\n    },\n\n    /**\n     * will set or remove the attribute based on the truthyness of the value.\n     * if the type of value === object (accounts for array) and the node is a custom pwc, it will json stringify the value\n     * @param node\n     * @param attr\n     * @param value\n     */\n    updateAttribute = (node, attr, value) => {\n        (value === null || value === false)\n            ? node.removeAttribute(attr)\n            : node.setAttribute(attr, (isObj(value) || isArray(value)) ? JSON.stringify(value) : value);\n    },\n    propToAttr = (prop) => prop.replace(/([A-Z])/g, \"-$1\").toLowerCase(),\n    attrToProp = (attr) => attr.replace(/-(\\w)/g, (all, letter) => letter.toUpperCase());\n\n\n    visibilityStyleSheet(` .___ {visibility: inherit;}`, true);\n\nexport {\n    TEST_ENV,\n    styleSheet,\n    globalStyles,\n    webComponentVisibility,\n    formatType,\n    updateAttribute,\n    propToAttr,\n    attrToProp,\n};\n","import {\n    formatType,\n    updateAttribute,\n    propToAttr,\n    attrToProp,\n    webComponentVisibility,\n    TEST_ENV\n} from \"../src/utils\";\n\nimport {def, extend} from \"@iosio/util\";\n\nimport {h, render} from \"preact\";\n\nlet PROPS = Symbol(),\n    IGNORE_ATTR = Symbol(),\n    context = {},\n    pwc = (tag, component, propTypes) => {\n        webComponentVisibility(tag);\n        customElements.define(tag, class extends PWC {\n                static propTypes = component.propTypes || propTypes;\n                render = props => h(component, props);\n            }\n        );\n        return (props) => h(tag, props, props.children);\n    },\n    x = (t, c, p) => pwc('x-' + t, c, p);\n\n\nclass PWC extends HTMLElement {\n    //easier theming\n    context = context;\n\n    constructor() {\n        super();\n        this._root = this.attachShadow({mode: 'open'});//  (this.shadowRoot || this) maybe eventually include the option to not use shadowDom\n        this[PROPS] = {};\n        this._mounted = new Promise(mount => (this._mount = mount));\n        this.update();\n        let {_initAttrs} = this.constructor;\n        let length = _initAttrs.length;\n        while (length--) _initAttrs[length](this);\n    }\n\n    /*\n     adding visibility inherit on next tick after (inspired by stencil.js)\n     will prevent flash of un-styled content (common complaint with web components).\n     Removing this functionality during testing makes life easier\n    */\n    update = () => {\n        if (!this._process) {\n            this._process = this._mounted.then(_ => {\n                render(this.render(extend({host: this}, this[PROPS])), this._root);\n                !this._hasMounted && !TEST_ENV && requestAnimationFrame(() => this.classList.add('___'));\n                this._hasMounted = true;\n                this._process = false;\n            });\n        }\n        return this._process;\n    };\n\n    connectedCallback() {\n        !this._hasMounted && this._mount();\n    }\n\n    emit = (name, detail, from) =>\n        (from || this).dispatchEvent(\n            new CustomEvent(name, {detail, bubbles: true, composed: true})\n        );\n\n    attributeChangedCallback(attr, oldValue, newValue) {\n        if (attr === this[IGNORE_ATTR] || oldValue === newValue) return;\n        this[attrToProp(attr)] = newValue;\n    }\n\n    /*\n        inspired by atomico\n        converts attributes to props as defined in the static propTypes.\n        defers the upgrading of the attributes till mounted, ignoring them to avoid re-rendering\n    */\n    static get observedAttributes() {\n        let {propTypes, prototype} = this;\n        this._initAttrs = [];\n        if (!propTypes) return [];\n        return Object.keys(propTypes).map(prop => {\n            let attr = propToAttr(prop),\n                schema = propTypes[prop].name ? {type: propTypes[prop]} : propTypes[prop];\n            if (!(prop in prototype)) {\n                def(prototype, prop, {\n                    get() {\n                        return this[PROPS][prop]\n                    },\n                    set(nextValue) {\n                        let {value, error} = formatType(nextValue, schema.type);\n                        if (error && value != null) throw `[${prop}] must be type [${schema.type.name}]`;\n                        if (value === this[PROPS][prop]) return;\n                        if (schema.reflect) {\n                            this._mounted.then(() => {\n                                this[IGNORE_ATTR] = attr;\n                                updateAttribute(this, attr, schema.type === Boolean && !value ? null : value);\n                                this[IGNORE_ATTR] = false;\n                            });\n                        }\n                        this[PROPS][prop] = value;\n                        this.update();\n                    }\n                });\n            }\n            schema.value && this._initAttrs.push(self => (self[prop] = schema.value));\n            return attr;\n        });\n    };\n\n    /*  web components may call disconnected callback when the node is just being moved.\n        for example, if a user manually relocates the web component in the dom via something like node.insertBefore ...\n        so checking if the web component is still connected is necessary  */\n    disconnectedCallback() {\n        !this.isConnected && render(() => null, this._root);\n    }\n}\n\nexport {x, pwc, context}\n\n\n\n"],"names":["d","document","TEST_ENV","styleSheet","style","createElement","head","appendChild","css","createTextNode","globalStyles","visibilityStyleSheet","webComponentVisibility","tag","formatType","value","type","String","Boolean","includes","Number","Object","Array","JSON","parse","toString","call","name","error","isNaN","e","updateAttribute","node","attr","removeAttribute","setAttribute","isObj","isArray","stringify","propToAttr","prop","replace","toLowerCase","attrToProp","all","letter","toUpperCase","PROPS","Symbol","IGNORE_ATTR","context","pwc","component","propTypes","customElements","define","render","props","h","PWC","children","x","t","c","p","update","_process","_mounted","then","_","extend","host","_root","_hasMounted","requestAnimationFrame","classList","add","emit","detail","from","dispatchEvent","CustomEvent","bubbles","composed","attachShadow","mode","Promise","mount","_mount","_initAttrs","constructor","length","oldValue","newValue","isConnected","prototype","keys","map","schema","def","get","set","nextValue","reflect","push","self","HTMLElement"],"mappings":";;;;;;;IAEIA,CAAC,GAAGC,QAAR;IACIC,QAAQ,GAAG,cAAyB,MADxC;;AAEI;;;;AAIAC,UAAU,GAAG,SAAbA,UAAa,CAACC,KAAD,EAAW;EACnBA,KAAK,GAAGJ,CAAC,CAACK,aAAF,CAAgB,OAAhB,CAAR;EACAL,CAAC,CAACM,IAAF,CAAOC,WAAP,CAAmBH,KAAnB;SACM,UAACI,GAAD;WAAUJ,KAAK,CAACG,WAAN,CAAkBP,CAAC,CAACS,cAAF,CAAiBD,GAAjB,CAAlB,GAA0CJ,KAApD;GAAP;CATR;IAWIM,YAAY,GAAGP,UAAU,EAX7B;IAYIQ,oBAAoB,GAAGR,UAAU,EAZrC;IAaIS,sBAAsB,GAAG,SAAzBA,sBAAyB,CAACC,GAAD;SAASF,oBAAoB,WAAIE,GAAJ,0BAA7B;CAb7B;;AAcI;;;;;;AAMAC,UAAU,GAAG,SAAbA,UAAa,CAACC,KAAD,EAAQC,IAAR,EAAiB;EAC1BA,IAAI,GAAGA,IAAI,IAAIC,MAAf;;MACI;QACID,IAAI,IAAIE,OAAZ,EAAqBH,KAAK,GAAG,CAAC,IAAD,EAAO,CAAP,EAAU,EAAV,EAAc,GAAd,EAAmB,MAAnB,EAA2BI,QAA3B,CAAoCJ,KAApC,CAAR,CAArB,KACK,IAAI,OAAOA,KAAP,IAAgB,QAApB,EAA8B;MAC/BA,KAAK,GAAGC,IAAI,IAAII,MAAR,GAAiBA,MAAM,CAACL,KAAD,CAAvB,GACFC,IAAI,IAAIK,MAAR,IAAkBL,IAAI,IAAIM,KAA1B,GAAkCC,IAAI,CAACC,KAAL,CAAWT,KAAX,CAAlC,GAAsDA,KAD5D;;QAGA,GAAGU,QAAH,CAAYC,IAAZ,CAAiBX,KAAjB,uBAAsCC,IAAI,CAACW,IAA3C,MAAJ,EACI,OAAO;MAACZ,KAAK,EAALA,KAAD;MAAQa,KAAK,EAAEZ,IAAI,IAAII,MAAR,IAAkBA,MAAM,CAACS,KAAP,CAAad,KAAb;KAAxC;GAPR,CAQE,OAAOe,CAAP,EAAU;;SAEL;IAACf,KAAK,EAALA,KAAD;IAAQa,KAAK,EAAE;GAAtB;CAhCR;;AAmCI;;;;;;;AAOAG,eAAe,GAAG,SAAlBA,eAAkB,CAACC,IAAD,EAAOC,IAAP,EAAalB,KAAb,EAAuB;EACpCA,KAAK,KAAK,IAAV,IAAkBA,KAAK,KAAK,KAA7B,GACMiB,IAAI,CAACE,eAAL,CAAqBD,IAArB,CADN,GAEMD,IAAI,CAACG,YAAL,CAAkBF,IAAlB,EAAyBG,UAAK,CAACrB,KAAD,CAAL,IAAgBsB,YAAO,CAACtB,KAAD,CAAxB,GAAmCQ,IAAI,CAACe,SAAL,CAAevB,KAAf,CAAnC,GAA2DA,KAAnF,CAFN;CA3CR;IA+CIwB,UAAU,GAAG,SAAbA,UAAa,CAACC,IAAD;SAAUA,IAAI,CAACC,OAAL,CAAa,UAAb,EAAyB,KAAzB,EAAgCC,WAAhC,EAAV;CA/CjB;IAgDIC,UAAU,GAAG,SAAbA,UAAa,CAACV,IAAD;SAAUA,IAAI,CAACQ,OAAL,CAAa,QAAb,EAAuB,UAACG,GAAD,EAAMC,MAAN;WAAiBA,MAAM,CAACC,WAAP,EAAjB;GAAvB,CAAV;CAhDjB;;AAmDInC,oBAAoB,iCAAiC,IAAjC,CAApB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ICxCAoC,KAAK,GAAGC,MAAM,EAAlB;IACIC,WAAW,GAAGD,MAAM,EADxB;IAEIE,OAAO,GAAG,EAFd;IAGIC,GAAG,GAAG,SAANA,GAAM,CAACtC,GAAD,EAAMuC,SAAN,EAAiBC,SAAjB,EAA+B;;;EACjCzC,sBAAsB,CAACC,GAAD,CAAtB;EACAyC,cAAc,CAACC,MAAf,CAAsB1C,GAAtB;;;;;;;;;;;;;;;;;;YAEQ2C,MAFR,GAEiB,UAAAC,KAAK;eAAIC,QAAC,CAACN,SAAD,EAAYK,KAAZ,CAAL;OAFtB;;;;;;IAAyCE,GAAzC,UACeN,SADf,GAC2BD,SAAS,CAACC,SAAV,IAAuBA,SADlD;SAKO,UAACI,KAAD;WAAWC,QAAC,CAAC7C,GAAD,EAAM4C,KAAN,EAAaA,KAAK,CAACG,QAAnB,CAAZ;GAAP;CAVR;IAYIC,CAAC,GAAG,SAAJA,CAAI,CAACC,CAAD,EAAIC,CAAJ,EAAOC,CAAP;SAAab,GAAG,CAAC,OAAOW,CAAR,EAAWC,CAAX,EAAcC,CAAd,CAAhB;CAZR;;IAeML;;;;;;iBAIY;;;;;;WAFdT,OAEc,GAFJA,OAEI;;WAgBde,MAhBc,GAgBL,YAAM;UACP,CAAC,OAAKC,QAAV,EAAoB;eACXA,QAAL,GAAgB,OAAKC,QAAL,CAAcC,IAAd,CAAmB,UAAAC,CAAC,EAAI;UACpCb,aAAM,CAAC,OAAKA,MAAL,CAAYc,WAAM,CAAC;YAACC,IAAI;WAAN,EAAe,OAAKxB,KAAL,CAAf,CAAlB,CAAD,EAAiD,OAAKyB,KAAtD,CAAN;WACC,OAAKC,WAAN,IAAqB,CAACvE,QAAtB,IAAkCwE,qBAAqB,CAAC;mBAAM,OAAKC,SAAL,CAAeC,GAAf,CAAmB,KAAnB,CAAN;WAAD,CAAvD;iBACKH,WAAL,GAAmB,IAAnB;iBACKP,QAAL,GAAgB,KAAhB;SAJY,CAAhB;;;aAOG,OAAKA,QAAZ;KAzBU;;WAgCdW,IAhCc,GAgCP,UAAClD,IAAD,EAAOmD,MAAP,EAAeC,IAAf;aACH,CAACA,IAAI,kCAAL,EAAeC,aAAf,CACI,IAAIC,WAAJ,CAAgBtD,IAAhB,EAAsB;QAACmD,MAAM,EAANA,MAAD;QAASI,OAAO,EAAE,IAAlB;QAAwBC,QAAQ,EAAE;OAAxD,CADJ,CADG;KAhCO;;WAELX,KAAL,GAAa,OAAKY,YAAL,CAAkB;MAACC,IAAI,EAAE;KAAzB,CAAb,CAFU;;WAGLtC,KAAL,IAAc,EAAd;WACKoB,QAAL,GAAgB,IAAImB,OAAJ,CAAY,UAAAC,KAAK;aAAK,OAAKC,MAAL,GAAcD,KAAnB;KAAjB,CAAhB;;WACKtB,MAAL;;QACKwB,UANK,GAMS,OAAKC,WANd,CAMLD,UANK;QAONE,MAAM,GAAGF,UAAU,CAACE,MAAxB;;WACOA,MAAM,EAAb;MAAiBF,UAAU,CAACE,MAAD,CAAV;;;;;;;;;;;;;;wCAoBD;OACf,KAAKlB,WAAN,IAAqB,KAAKe,MAAL,EAArB;;;;6CAQqBvD,MAAM2D,UAAUC,UAAU;UAC3C5D,IAAI,KAAK,KAAKgB,WAAL,CAAT,IAA8B2C,QAAQ,KAAKC,QAA/C,EAAyD;WACpDlD,UAAU,CAACV,IAAD,CAAf,IAAyB4D,QAAzB;;;;;;;;;;;;;;2CA4CmB;OAClB,KAAKC,WAAN,IAAqBtC,aAAM,CAAC;eAAM,IAAN;OAAD,EAAa,KAAKgB,KAAlB,CAA3B;;;;wBArC4B;;;UACvBnB,SADuB,GACC,IADD,CACvBA,SADuB;UACZ0C,SADY,GACC,IADD,CACZA,SADY;WAEvBN,UAAL,GAAkB,EAAlB;UACI,CAACpC,SAAL,EAAgB,OAAO,EAAP;aACThC,MAAM,CAAC2E,IAAP,CAAY3C,SAAZ,EAAuB4C,GAAvB,CAA2B,UAAAzD,IAAI,EAAI;YAClCP,IAAI,GAAGM,UAAU,CAACC,IAAD,CAArB;YACI0D,MAAM,GAAG7C,SAAS,CAACb,IAAD,CAAT,CAAgBb,IAAhB,GAAuB;UAACX,IAAI,EAAEqC,SAAS,CAACb,IAAD;SAAvC,GAAiDa,SAAS,CAACb,IAAD,CADvE;;YAEI,EAAEA,IAAI,IAAIuD,SAAV,CAAJ,EAA0B;UACtBI,QAAG,CAACJ,SAAD,EAAYvD,IAAZ,EAAkB;YACjB4D,GADiB,iBACX;qBACK,KAAKrD,KAAL,EAAYP,IAAZ,CAAP;aAFa;YAIjB6D,GAJiB,eAIbC,SAJa,EAIF;;;gCACUxF,UAAU,CAACwF,SAAD,EAAYJ,MAAM,CAAClF,IAAnB,CADpB;kBACND,KADM,eACNA,KADM;kBACCa,KADD,eACCA,KADD;;kBAEPA,KAAK,IAAIb,KAAK,IAAI,IAAtB,EAA4B,iBAAUyB,IAAV,6BAAiC0D,MAAM,CAAClF,IAAP,CAAYW,IAA7C;kBACxBZ,KAAK,KAAK,KAAKgC,KAAL,EAAYP,IAAZ,CAAd,EAAiC;;kBAC7B0D,MAAM,CAACK,OAAX,EAAoB;qBACXpC,QAAL,CAAcC,IAAd,CAAmB,YAAM;kBACrB,MAAI,CAACnB,WAAD,CAAJ,GAAoBhB,IAApB;kBACAF,eAAe,CAAC,MAAD,EAAOE,IAAP,EAAaiE,MAAM,CAAClF,IAAP,KAAgBE,OAAhB,IAA2B,CAACH,KAA5B,GAAoC,IAApC,GAA2CA,KAAxD,CAAf;kBACA,MAAI,CAACkC,WAAD,CAAJ,GAAoB,KAApB;iBAHJ;;;mBAMCF,KAAL,EAAYP,IAAZ,IAAoBzB,KAApB;mBACKkD,MAAL;;WAhBL,CAAH;;;QAoBJiC,MAAM,CAACnF,KAAP,IAAgB,MAAI,CAAC0E,UAAL,CAAgBe,IAAhB,CAAqB,UAAAC,IAAI;iBAAKA,IAAI,CAACjE,IAAD,CAAJ,GAAa0D,MAAM,CAACnF,KAAzB;SAAzB,CAAhB;eACOkB,IAAP;OAzBG,CAAP;;;;;mBAvDUyE;;;;;;;"}